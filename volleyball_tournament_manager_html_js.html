<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Volleyball Tournament Manager</title>
  <style>
    :root { font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; padding: 16px; background:#0b0c10; color:#eaf0f6; }
    h1, h2, h3 { margin: 0 0 8px; }
    .wrap { display:grid; gap:16px; max-width:1200px; margin:0 auto; }
    .card { background:#11141a; border:1px solid #232a35; border-radius:12px; padding:16px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input[type="text"], select { background:#0e1218; color:#eaf0f6; border:1px solid #2a3442; border-radius:8px; padding:8px 10px; }
    input[type="number"]{ width:72px; }
    button { background:#2e7dff; color:white; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; }
    button.secondary { background:#1c2633; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .muted { opacity:.8; font-size:.9rem; }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { border-bottom:1px solid #1e2430; padding:8px; text-align:left; }
    .pill { padding:2px 8px; border-radius:999px; font-size:.85rem; border:1px solid #2a3442; }
    .ok { background:#10381a; color:#8ef39a; border-color:#1f7a36; }
    .warn { background:#3a1e10; color:#ffb88f; border-color:#7a3c1f; }
    .grid { display:grid; gap:12px; }
    .match { display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:8px; border:1px solid #202735; border-radius:10px; }
    .tiny { font-size:.85rem; opacity:.9; }
    .hr { height:1px; background:#1e2430; margin:12px 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .winner { color:#8ef39a; font-weight:600; }
    .bracket-col { display:grid; gap:8px; }
    .bracket-row { display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; }
    .slot { padding:8px; border:1px dashed #2a3442; border-radius:10px; min-height:68px; }
    .center { display:flex; justify-content:center; align-items:center; }
    .note { background:#142033; border-left:3px solid #2e7dff; padding:8px 12px; border-radius:6px; }
    a { color:#9cc4ff; }
    details { margin-top:8px; }
    summary { cursor:pointer; }
    .pass { color:#8ef39a; }
    .fail { color:#ffb88f; }

    /* Mobile & tablet friendly tweaks */
    html { -webkit-text-size-adjust: 100%; }
    * { -webkit-tap-highlight-color: transparent; }
    input, select, button { font-size: 16px; } /* prevent iOS zoom on focus */
    button, input, select { min-height: 44px; } /* comfy touch targets */

    /* Tables scroll horizontally on small screens */
    .table-wrap { overflow-x: auto; }
    .table { min-width: 520px; }

    /* Match row inputs/selects sizing */
    .match select { min-width: 140px; }
    .match input[type="number"] { width: 84px; }

    /* Bracket grid responsiveness */
    @media (max-width: 1024px) {
      .wrap { padding: 8px; }
      .bracket-row { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 720px) {
      .row { gap: 6px; }
      .card { padding: 12px; }
      .match { gap: 6px; }
      .match select { min-width: 120px; }
      .match input[type="number"] { width: 72px; }
      .table { min-width: 460px; }
    }
    /* On phones/small tablets, bracket turns into a horizontal scroller */
    @media (max-width: 600px) {
      .bracket-row { 
        grid-auto-flow: column; 
        grid-auto-columns: 85%;
        grid-template-columns: none; 
        overflow-x: auto; 
        -webkit-overflow-scrolling: touch; 
        gap: 10px;
        padding-bottom: 6px;
      }
      .bracket-col { min-width: 100%; }
    }

    /* Fine-tune controls and layout on narrow viewports */
    @media (max-width: 480px) {
      body { padding: 12px; }
      .wrap { gap: 12px; }
      h1 { font-size: 1.35rem; }
      h2 { font-size: 1.1rem; }
      h3 { font-size: 1rem; }
      .muted { font-size: .85rem; }
      button { padding: 10px 12px; }
      input[type="text"] { width: 100%; box-sizing: border-box; }
      #teamsCard .row { width: 100%; }
    }

    /* Larger checkbox for touch */
    input[type="checkbox"] { width: 20px; height: 20px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Volleyball Tournament Manager</h1>
    <p class="muted">Vanilla HTML + JS. Team check-in, pool scheduling, scoring, standings, and a 10-seed elimination bracket (1 and 2 get byes). Five-round mode adds a no-score “Bye game” row each round.</p>

    <!-- Team Registration & Check in -->
    <section class="card" id="teamsCard">
      <h2>1) Team Registration & Check in</h2>
      <form id="teamForm" class="row" autocomplete="off">
        <input id="teamName" type="text" placeholder="Team name" />
        <button id="addTeam" type="submit">Add team</button>
        <button id="clearTeams" type="button" class="secondary">Clear all</button>
        <span class="muted">Max 12 teams. If odd, a BYE will be added for scheduling.</span>
      </form>
      <div class="hr"></div>
      <div class="table-wrap">
        <table class="table" id="teamsTable">
          <thead>
            <tr><th>#</th><th>Name</th><th>Checked in</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Pool Play Scheduling -->
    <section class="card" id="poolCard">
      <h2>2) Pool Play</h2>
      <div class="row" style="flex-wrap:wrap; gap:12px;">
        <label>Rounds:
          <select id="roundCount">
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </label>
        <label class="row" style="gap:6px;">
          <input type="checkbox" id="manualMode" />
          <span class="muted">Manual schedule (choose teams per match)</span>
        </label>
        <button id="makeSchedule">Create schedule</button>
        <button id="resetSchedule" class="secondary">Reset</button>
      </div>
      <div id="poolSchedule" class="grid" style="margin-top:12px;"></div>
      <div class="hr"></div>
      <div id="standings"></div>
      <div class="row">
        <button id="finalizePool" disabled>Finalize pool & compute rankings</button>
      </div>
    </section>

    <!-- Bracket -->
    <section class="card" id="bracketCard">
      <h2>3) Elimination Bracket (10 teams)</h2>
      <p class="muted">Seeds 1 and 2 receive a first round bye. 7v10 and 8v9 play-in feed the quarterfinals.</p>
      <div class="row">
        <button id="buildBracket" disabled>Build bracket from rankings</button>
        <button id="resetBracket" class="secondary">Reset bracket</button>
      </div>
      <div id="bracket"></div>
      <div id="champion" class="center" style="margin-top:12px;"></div>
      <div class="note tiny" style="margin-top:12px;">
        Tip: reload the page to start fresh. Data is kept in memory only.
      </div>
    </section>

    <!-- Test runner (optional) -->
    <section class="card" id="testsCard">
      <h2>4) Built-in tests</h2>
      <button id="runTests" class="secondary">Run tests (see console)</button>
      <details>
        <summary>What is covered</summary>
        <ul class="tiny">
          <li>Adding teams via Enter and via Add team button</li>
          <li>Round creation (auto) and presence of Bye game row when 5 rounds chosen</li>
          <li>Save Round skips Bye game and updates standings</li>
          <li>Finalize requires all non-bye matches saved</li>
          <li>Bye uniqueness and rematch prevention</li>
          <li>Final is best-of-3 sets</li>
        </ul>
      </details>
      <div id="testResults" class="tiny"></div>
    </section>

    <footer class="muted tiny">© Tournament Helper — single file demo. MIT license. Built for quick on-site use.</footer>
  </div>

<script>
"use strict";
/*****************************
 * State
 *****************************/
var state = {
  teams: [], // {id, name, checked, wins, diff}
  schedule: [], // [{round, matches:[{a,b,aScore,bScore,winnerId,diff,played,isBye}], bye:{a,b}}]
  standings: [],
  rankings: [],
  bracket: null
};
var nextTeamId = 1;

/*****************************
 * Helpers
 *****************************/
function el(sel){ return document.querySelector(sel); }
function create(tag, props, children){
  if(props===undefined) props={}; if(children===undefined) children=[];
  var n = document.createElement(tag);
  for (var k in props){ if(props.hasOwnProperty(k)){ if(k==='class') n.className = props[k]; else if(k==='html') n.innerHTML = props[k]; else n.setAttribute(k, props[k]); }}
  var arr = Array.isArray(children) ? children : [children];
  arr.forEach(function(c){ n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c); });
  return n;
}
function teamName(id){ if(id==='BYE') return 'BYE'; var t=state.teams.find(function(x){return x.id===id;}); return t? t.name : '—'; }
function buildSelect(id, withBye, placeholder){
  var s = create('select', { id:id });
  if(placeholder){ s.appendChild(create('option', { value:'' }, placeholder)); }
  var src = withBye ? state.teams.concat([{id:'BYE', name:'BYE'}]) : state.teams;
  src.forEach(function(t){ s.appendChild(create('option', { value:String(t.id) }, t.name)); });
  return s;
}

/*****************************
 * 1) Team registration & check-in
 *****************************/
function addTeam(name){
  if(!name) return;
  if(state.teams.length >= 12){ alert('Max 12 teams.'); return; }
  state.teams.push({ id: nextTeamId++, name: String(name).trim(), checked: false, wins: 0, diff: 0 });
  renderTeams();
}
function removeTeam(id){ state.teams = state.teams.filter(function(t){return t.id!==id;}); renderTeams(); }
function toggleCheck(id){ var t=state.teams.find(function(x){return x.id===id;}); if(t){ t.checked = !t.checked; renderTeams(); } }
function renderTeams(){
  var tbody = el('#teamsTable tbody');
  tbody.innerHTML = '';
  state.teams.forEach(function(t,i){
    var tr = document.createElement('tr');
    tr.appendChild(create('td', {}, String(i+1)));
    var nameTd = create('td'); nameTd.appendChild(create('span', { class: t.checked? 'winner':'' }, t.name)); tr.appendChild(nameTd);
    tr.appendChild(create('td', {}, create('span', { class:(t.checked? 'pill ok':'pill warn') }, t.checked? 'checked in':'not checked')));
    var actions = create('td');
    var btnCheck = create('button'); btnCheck.textContent = t.checked? 'Uncheck':'Check in'; btnCheck.addEventListener('click',function(){toggleCheck(t.id);}); actions.appendChild(btnCheck);
    actions.appendChild(create('span', { style:'display:inline-block;width:8px;' }, ''));
    var btnRemove = create('button', { class:'secondary' }); btnRemove.textContent='Remove'; btnRemove.addEventListener('click',function(){removeTeam(t.id);}); actions.appendChild(btnRemove);
    tr.appendChild(actions);
    tbody.appendChild(tr);
  });
}

/*****************************
 * 2) Pool scheduling
 *****************************/
function roundRobinPairings(teamIds){
  var ids = teamIds.slice();
  if(ids.length % 2 === 1) ids.push('BYE');
  var n = ids.length, half = n/2, rounds=[];
  var left = ids.slice(0,half), right = ids.slice(half).reverse();
  for(var r=0; r<n-1; r++){
    var pairings=[];
    for(var i=0;i<half;i++){
      var a=left[i], b=right[i];
      if(a!=='BYE' && b!=='BYE') pairings.push([a,b]);
      else if(a==='BYE' && b!=='BYE') pairings.push([b,'BYE']);
      else if(b==='BYE' && a!=='BYE') pairings.push([a,'BYE']);
    }
    rounds.push(pairings);
    var fixed = left[0];
    var firstRight = right[0];
    right = right.slice(1).concat(left.pop());
    left = [fixed].concat([firstRight]).concat(left.slice(1));
  }
  return rounds;
}

function createSchedule(roundCount){
  var poolTeams = state.teams.filter(function(t){return t.checked;});
  if(poolTeams.length===0) poolTeams = state.teams.slice();
  if(poolTeams.length < 2){ alert('Need at least 2 teams.'); return; }
  var ids = poolTeams.map(function(t){return t.id;});
  var manual = el('#manualMode').checked;

  if(!manual){
    var rr = roundRobinPairings(ids).slice(0, roundCount);
    state.schedule = rr.map(function(pairings, idx){
      return { round: idx+1,
        matches: pairings.slice(0, 4).map(function(p){ return { a:p[0], b:p[1], aScore:'', bScore:'', winnerId:null, diff:0, played:false }; }),
        bye: null };
    });
  } else {
    var matchesPerRound = 4; // manual mode: exactly 4 matches per round
    state.schedule = Array.from({length: roundCount}, function(_,r){
      return { round: r+1,
        matches: Array.from({length: matchesPerRound}, function(){ return { a:null, b:null, aScore:'', bScore:'', winnerId:null, diff:0, played:false }; }),
        bye: null };
    });
  }

  state.schedule.forEach(function(r){
    if(r.matches.length > 4) r.matches = r.matches.slice(0,4);
    while(r.matches.length < 4){ r.matches.push({ a:null, b:null, aScore:'', bScore:'', winnerId:null, diff:0, played:false }); }
    r.bye = null; // set below for 5-round
  });

  if(roundCount === 5){
    state.schedule.forEach(function(r){
      r.matches.push({ isBye:true, a:'BYE', b:'BYE', aScore:'', bScore:'', winnerId:null, diff:0, played:true });
      r.bye = { a: null, b: null }; // store which two teams rest
    });
  }

  state.teams.forEach(function(t){ t.wins=0; t.diff=0; });
  state.standings = []; state.rankings = [];
  renderSchedule();
  renderStandings();
  el('#finalizePool').disabled = false;
}

function renderSchedule(){
  var holder = el('#poolSchedule'); holder.innerHTML='';
  if(state.schedule.length===0) return;
  state.schedule.forEach(function(r){
    var wrap = create('div', { class:'card', id:'round-'+r.round });
    wrap.appendChild(create('h3', {}, 'Round ' + r.round));

    r.matches.forEach(function(m, idx){
      var row = create('div', { class:'match', id:'match-'+r.round+'-'+idx });

      if(m.isBye){
        var byeWrap = create('div', { class:'row' });
        byeWrap.appendChild(create('strong', {}, 'Bye game'));
        var aSelB = buildSelect('byeA-'+r.round, false, 'Select team A (rest)');
        var bSelB = buildSelect('byeB-'+r.round, false, 'Select team B (rest)');
        if(r.bye && r.bye.a) aSelB.value = String(r.bye.a);
        if(r.bye && r.bye.b) bSelB.value = String(r.bye.b);
        byeWrap.appendChild(aSelB);
        byeWrap.appendChild(create('span', { class:'mono' }, 'and'));
        byeWrap.appendChild(bSelB);
        byeWrap.appendChild(create('span', { class:'muted tiny' }, ' — these two teams rest; no scores recorded'));
        row.appendChild(byeWrap);
        wrap.appendChild(row);
        return;
      }

      if(m.a===null || m.b===null){
        var aSel = buildSelect('aSel-'+r.round+'-'+idx, true);
        var bSel = buildSelect('bSel-'+r.round+'-'+idx, true);
        row.appendChild(aSel);
        row.appendChild(create('span', { class:'mono' }, 'vs'));
        row.appendChild(bSel);
      } else {
        row.appendChild(create('div', { class:'mono' }, teamName(m.a)));
        row.appendChild(create('div', { class:'mono' }, 'vs'));
        row.appendChild(create('div', { class:'mono' }, teamName(m.b)));
      }

      var aValForInput = (m.aScore!=null? m.aScore : '');
      var bValForInput = (m.bScore!=null? m.bScore : '');
      var aIn = create('input', { type:'number', min:'0', value:aValForInput, placeholder:'A score', id:'aScore-'+r.round+'-'+idx });
      var bIn = create('input', { type:'number', min:'0', value:bValForInput, placeholder:'B score', id:'bScore-'+r.round+'-'+idx });
      var statusText = m.played? ('Saved. Winner: ' + teamName(m.winnerId) + ' (diff ' + m.diff + ')') : '';
      var status = create('span', { class:'tiny muted', style:'margin-left:8px;', id:'status-'+r.round+'-'+idx }, statusText);
      row.append(aIn,bIn,status);
      wrap.appendChild(row);
    });

    var saveRoundBtn = create('button', { id:'saveRound-'+r.round }, 'Save Round ' + r.round);
    saveRoundBtn.addEventListener('click', function(){ saveRound(r.round); });
    wrap.appendChild(saveRoundBtn);

    holder.appendChild(wrap);
  });
}

function pairKey(a,b){ if(a==='BYE' || b==='BYE') return null; var x = typeof a==='number'? a : parseInt(a,10); var y = typeof b==='number'? b : parseInt(b,10); var p = x<y? x:y; var q = x<y? y:x; return String(p)+'-'+String(q); }
function seenPairsBefore(roundNo){
  var map = new Map();
  state.schedule.forEach(function(r){
    if(r.round>=roundNo) return; r.matches.forEach(function(m){ if(m.isBye) return; if(m.a==null||m.b==null) return; var k = pairKey(m.a,m.b); if(k){ map.set(k, r.round); } });
  });
  return map;
}
function teamsWithByeSoFar(roundNo){
  var set = new Set();
  state.schedule.forEach(function(r){ if(r.round>=roundNo) return; if(r.bye){ if(r.bye.a!=null) set.add(r.bye.a); if(r.bye.b!=null) set.add(r.bye.b); } });
  return set;
}

function saveRound(roundNo){
  var r = state.schedule.find(function(x){return x.round===roundNo;}); if(!r) return;

  var byeSelectA = el('#byeA-'+roundNo);
  var byeSelectB = el('#byeB-'+roundNo);
  if (byeSelectA && byeSelectB) {
    var aValB = byeSelectA.value; var bValB = byeSelectB.value;
    if (!aValB || !bValB) { alert('Pick both bye teams for this round.'); return; }
    if (aValB === bValB) { alert('The two bye teams must be different.'); return; }
    var alreadyByed = teamsWithByeSoFar(roundNo);
    var aIdBye = parseInt(aValB,10), bIdBye = parseInt(bValB,10);
    if (alreadyByed.has(aIdBye) || alreadyByed.has(bIdBye)) { alert('A team can only receive one bye across pool play. Choose different teams.'); return; }
    r.bye = { a: aIdBye, b: bIdBye };
  }

  var appearances = new Map();
  function count(id){ if(id==='BYE') return; appearances.set(id, (appearances.get(id)||0)+1); }
  r.matches.forEach(function(m){ if(!m.isBye){ if(m.a) count(m.a); if(m.b) count(m.b); }});
  if (r.bye && r.bye.a) count(r.bye.a); if (r.bye && r.bye.b) count(r.bye.b);
  appearances.forEach(function(c, id){ if (c > 1) { alert('Team '+teamName(id)+' is scheduled more than once in Round '+roundNo+' (including bye). Adjust pairings/bye.'); throw new Error('dup'); } });

  var priorPairs = seenPairsBefore(roundNo);
  for(var idx=0; idx<r.matches.length; idx++){
    var m = r.matches[idx];
    if(m.isBye) continue;

    if(m.a===null || m.b===null){
      var aSel = el('#aSel-'+roundNo+'-'+idx);
      var bSel = el('#bSel-'+roundNo+'-'+idx);
      if(!aSel || !bSel){ alert('Missing team selects.'); return; }
      var aVal=aSel.value, bVal=bSel.value;
      if(!aVal || !bVal){ alert('Please choose teams for all matches.'); return; }
      if(aVal===bVal){ alert('A team cannot play itself. Choose different teams.'); return; }
      var aId = aVal==='BYE' ? 'BYE' : parseInt(aVal,10);
      var bId = bVal==='BYE' ? 'BYE' : parseInt(bVal,10);
      if (r.bye && (aId===r.bye.a || aId===r.bye.b || bId===r.bye.a || bId===r.bye.b)) { alert('A bye team is currently assigned to a match in this round. Adjust bye or match.'); return; }
      var k = pairKey(aId, bId);
      if(k && priorPairs.has(k)){
        var priorRound = priorPairs.get(k);
        alert('Rematch detected: '+teamName(aId)+' vs '+teamName(bId)+' already played in Round '+priorRound+'.');
        return;
      }
      m.a = aId; m.b = bId;
    }

    var aScore = parseInt(el('#aScore-'+roundNo+'-'+idx).value,10);
    var bScore = parseInt(el('#bScore-'+roundNo+'-'+idx).value,10);

    if(m.a!=='BYE' && m.b!=='BYE'){
      if(Number.isNaN(aScore) || Number.isNaN(bScore)) { alert('Enter scores for match '+(idx+1)+' in Round '+roundNo+'.'); return; }
      if(aScore===bScore){ alert('No ties. Please adjust one score.'); return; }
      if(aScore>bScore){ m.winnerId=m.a; m.diff=aScore-bScore; }
      else { m.winnerId=m.b; m.diff=bScore-aScore; }
      m.aScore=aScore; m.bScore=bScore; m.played=true;
    } else if(m.a==='BYE' && m.b!=='BYE'){
      m.winnerId=m.b; m.diff=0; m.played=true; m.aScore=''; m.bScore='';
    } else if(m.b==='BYE' && m.a!=='BYE'){
      m.winnerId=m.a; m.diff=0; m.played=true; m.aScore=''; m.bScore='';
    }

    var status = el('#status-'+roundNo+'-'+idx);
    if(status) status.textContent = m.played? ('Saved. Winner: '+teamName(m.winnerId)+' (diff '+m.diff+')') : '';
  }
  recomputeStandings();
  renderStandings();
  renderSchedule();
}

function recomputeStandings(){
  state.teams.forEach(function(t){ t.wins=0; t.diff=0; });
  state.schedule.forEach(function(r){ r.matches.forEach(function(m){
    if(!m.played) return;
    if(m.a==='BYE' || m.b==='BYE') return;
    var ta = state.teams.find(function(t){return t.id===m.a;});
    var tb = state.teams.find(function(t){return t.id===m.b;});
    if(!ta || !tb) return;
    var d = Math.abs(m.aScore - m.bScore);
    if(m.winnerId===ta.id){ ta.wins+=1; ta.diff+=d; tb.diff-=d; }
    else { tb.wins+=1; tb.diff+=d; ta.diff-=d; }
  }); });
  var rows = state.teams.map(function(t){return { id:t.id, name:t.name, wins:t.wins, diff:t.diff };});
  rows.sort(function(a,b){ return (b.wins - a.wins) || (b.diff - a.diff) || a.name.localeCompare(b.name); });
  state.standings = rows;
}

function renderStandings(){
  recomputeStandings();
  var box = el('#standings');
  if(state.standings.length===0){ box.innerHTML=''; return; }
  var table = create('table', { class:'table' });
  table.appendChild(create('thead', {}, create('tr', {}, [
    create('th', {}, '#'), create('th', {}, 'Team'), create('th', {}, 'Wins'), create('th', {}, 'Point diff')
  ])));
  var tb = create('tbody');
  state.standings.forEach(function(s,i){
    tb.appendChild(create('tr', {}, [
      create('td', {}, String(i+1)), create('td', {}, s.name), create('td', {}, String(s.wins)), create('td', {}, String(s.diff))
    ]));
  });
  table.appendChild(tb);
  box.innerHTML='';
  box.appendChild(create('h3', {}, 'Current standings'));
  box.appendChild(table);
}

function finalizePool(){
  for(var i=0;i<state.schedule.length;i++){
    var r = state.schedule[i];
    if (r.bye && (r.bye.a==null || r.bye.b==null)) return alert('Round '+r.round+' bye teams not selected.');
    for(var j=0;j<r.matches.length;j++){
      var m=r.matches[j];
      if(m.isBye) continue;
      if(!m.played) return alert('Round '+r.round+' has an unsaved match. Use \"Save Round '+r.round+'\".');
    }
  }
  recomputeStandings();
  state.rankings = state.standings.map(function(s){return s.id;});
  alert('Pool complete. Rankings locked. You can now build the bracket.');
  el('#buildBracket').disabled = false;
}

/*****************************
 * 3) Elimination bracket (10 teams)
 *****************************/
function buildBracketFromRankings(){
  var n = state.rankings.length;
  if(n < 10) alert('Bracket expects 10 teams. Fewer teams will be padded with BYE.');
  var seeds = state.rankings.slice(0,10);
  while(seeds.length < 10) seeds.push('BYE');
  state.bracket = {
    playins:[
      { id:'P1', a:seeds[6], b:seeds[9], aScore:'', bScore:'', winner:null },
      { id:'P2', a:seeds[7], b:seeds[8], aScore:'', bScore:'', winner:null }
    ],
    quarters:[
      { id:'Q1', a:seeds[0], b:{from:'P2'}, aScore:'', bScore:'', winner:null },
      { id:'Q2', a:seeds[3], b:seeds[4], aScore:'', bScore:'', winner:null },
      { id:'Q3', a:seeds[2], b:{from:'P1'}, aScore:'', bScore:'', winner:null },
      { id:'Q4', a:seeds[1], b:seeds[5], aScore:'', bScore:'', winner:null }
    ],
    semis:[
      { id:'S1', a:{from:'Q1'}, b:{from:'Q2'}, aScore:'', bScore:'', winner:null },
      { id:'S2', a:{from:'Q3'}, b:{from:'Q4'}, aScore:'', bScore:'', winner:null }
    ],
    final:{ id:'F', a:{from:'S1'}, b:{from:'S2'}, aScore:'', bScore:'', winner:null, sets:[{a:'',b:''},{a:'',b:''},{a:'',b:''}] }
  };
  renderBracket();
}

function resolveEntry(entry){
  if(entry==='BYE') return 'BYE';
  if(typeof entry==='number') return teamName(entry);
  if(entry && entry.from){ var w = findWinner(entry.from); return w? w : ('Winner of '+entry.from); }
  return '—';
}
function findWinner(id){
  var b = state.bracket; var all = b.playins.concat(b.quarters).concat(b.semis).concat([b.final]);
  var m = all.find(function(x){return x.id===id;}); if(!m || !m.winner) return null; return teamName(m.winner) || 'BYE';
}
function isByeEntry(entry){ return entry==='BYE'; }
function getEntryId(entry){
  if(typeof entry==='number') return entry;
  if(entry==='BYE') return 'BYE';
  if(entry && entry.from){
    var b = state.bracket; var find = function(ix){ return b.playins.concat(b.quarters).concat(b.semis).concat([b.final]).find(function(x){ return x.id===ix; }); };
    var m = find(entry.from); return (m && m.winner) ? m.winner : null;
  }
  return null;
}
function recordBracketScore(stage, idx, aVal, bVal){
  var st = state.bracket[stage]; var m = Array.isArray(st)? st[idx] : st;
  if(stage==='final') return; // final handled separately
  var a = parseInt(aVal,10), b = parseInt(bVal,10);
  if(Number.isNaN(a) || Number.isNaN(b) || a<0 || b<0) return alert('Enter valid non negative scores.');
  m.aScore=a; m.bScore=b;
  if(isByeEntry(m.a) && !isByeEntry(m.b)) m.winner = getEntryId(m.b);
  else if(!isByeEntry(m.a) && isByeEntry(m.b)) m.winner = getEntryId(m.a);
  else if(a===b) return alert('No ties in elimination.');
  else m.winner = a>b ? getEntryId(m.a) : getEntryId(m.b);
  renderBracket();
}

function recordFinalSets(a1,b1,a2,b2,a3,b3){
  var m = state.bracket.final;
  var A = [a1,a2,a3].map(function(x){ return x===''? '' : parseInt(x,10); });
  var B = [b1,b2,b3].map(function(x){ return x===''? '' : parseInt(x,10); });
  if(A[0]==='' || B[0]==='' || A[1]==='' || B[1]==='') return alert('Enter scores for Set 1 and Set 2.');
  function checkSet(a,b,idx){ if(a===b) throw new Error('Set '+(idx+1)+' cannot be a tie.'); if(Number.isNaN(a)||Number.isNaN(b)||a<0||b<0) throw new Error('Scores must be non-negative numbers.'); }
  try{
    checkSet(A[0],B[0],0); checkSet(A[1],B[1],1);
    if(A[0]>B[0] && A[1]>B[1]){ m.winner = getEntryId(m.a); }
    else if(A[0]<B[0] && A[1]<B[1]){ m.winner = getEntryId(m.b); }
    else {
      if(A[2]==='' || B[2]==='') return alert('Match is 1–1. Enter Set 3 scores.');
      checkSet(A[2],B[2],2);
      m.winner = (A[2]>B[2]) ? getEntryId(m.a) : getEntryId(m.b);
    }
  } catch(e){ alert(e.message); return; }
  m.sets = [{a:A[0],b:B[0]},{a:A[1],b:B[1]},{a:A[2],b:B[2]}];
  renderBracket();
  if(m.winner){ el('#champion').innerHTML = '<h2>Champion: <span class="winner">'+teamName(m.winner)+'</span></h2>'; }
}

function renderBracket(){
  var b = state.bracket; var box = el('#bracket'); box.innerHTML=''; if(!b) return;
  function col(title, items, stageKey){
    var container = create('div', { class:'bracket-col' });
    container.appendChild(create('h3', {}, title));
    (Array.isArray(items)? items : [items]).forEach(function(m, idx){
      var a = resolveEntry(m.a), bName = resolveEntry(m.b);
      var slot = create('div', { class:'slot' });

      if(stageKey==='final'){
        slot.appendChild(create('div', { class:'mono' }, a+' vs '+bName));
        var f1a = (m.sets && m.sets[0] && m.sets[0].a!=null ? m.sets[0].a : '');
        var f1b = (m.sets && m.sets[0] && m.sets[0].b!=null ? m.sets[0].b : '');
        var f2a = (m.sets && m.sets[1] && m.sets[1].a!=null ? m.sets[1].a : '');
        var f2b = (m.sets && m.sets[1] && m.sets[1].b!=null ? m.sets[1].b : '');
        var f3a = (m.sets && m.sets[2] && m.sets[2].a!=null ? m.sets[2].a : '');
        var f3b = (m.sets && m.sets[2] && m.sets[2].b!=null ? m.sets[2].b : '');
        var r1 = create('div', { class:'row' }, [ create('span', { class:'muted tiny' }, 'Set 1'), create('input', { type:'number', min:'0', value:f1a }), create('input', { type:'number', min:'0', value:f1b }) ]);
        var r2 = create('div', { class:'row' }, [ create('span', { class:'muted tiny' }, 'Set 2'), create('input', { type:'number', min:'0', value:f2a }), create('input', { type:'number', min:'0', value:f2b }) ]);
        var r3 = create('div', { class:'row' }, [ create('span', { class:'muted tiny' }, 'Set 3 (if needed)'), create('input', { type:'number', min:'0', value:f3a }), create('input', { type:'number', min:'0', value:f3b }) ]);
        var save = create('button', {}, 'Save Final');
        save.addEventListener('click', function(){
          var vals = [r1,r2,r3].map(function(rr){ return Array.from(rr.querySelectorAll('input')).map(function(i){return i.value;}); });
          recordFinalSets(vals[0][0],vals[0][1],vals[1][0],vals[1][1],vals[2][0],vals[2][1]);
        });
        var status = create('div', { class:'tiny muted', style:'margin-top:6px;' }, m.winner? ('Winner: '+teamName(m.winner)+' (best of 3)') : '');
        slot.append(r1,r2,r3,save,status);
      } else {
        var va = (m.aScore!=null? m.aScore : '');
        var vb = (m.bScore!=null? m.bScore : '');
        var row1 = create('div', { class:'row' }, [ create('div', { class:'mono' }, a), create('span', { class:'muted tiny' }, 'score'), create('input', { type:'number', min:'0', value:va }) ]);
        var row2 = create('div', { class:'row' }, [ create('div', { class:'mono' }, bName), create('span', { class:'muted tiny' }, 'score'), create('input', { type:'number', min:'0', value:vb }) ]);
        var save2 = create('button', {}, 'Save');
        save2.addEventListener('click', function(){
          var aVal = row1.querySelector('input').value; var bVal = row2.querySelector('input').value;
          recordBracketScore(stageKey, Array.isArray(items)? idx : undefined, aVal, bVal);
        });
        var status2 = create('div', { class:'tiny muted', style:'margin-top:6px;' }, m.winner? ('Winner: '+teamName(m.winner)) : '');
        slot.append(row1,row2,save2,status2);
      }
      container.appendChild(slot);
    });
    return container;
  }
  var grid = create('div', { class:'bracket-row' });
  grid.appendChild(col('Play in', state.bracket.playins, 'playins'));
  grid.appendChild(col('Quarterfinals', state.bracket.quarters, 'quarters'));
  grid.appendChild(col('Semifinals', state.bracket.semis, 'semis'));
  grid.appendChild(col('Final', state.bracket.final, 'final'));
  box.appendChild(grid);
}

/*****************************
 * Wire up UI
 *****************************/
document.addEventListener('DOMContentLoaded', function(){
  // Team form submit handles both Enter and the Add Team button
  el('#teamForm').addEventListener('submit', function(e){
    e.preventDefault();
    var input = el('#teamName'); var name = input.value.trim();
    addTeam(name); input.value=''; input.focus();
  });
  el('#clearTeams').addEventListener('click', function(){
    if(!confirm('Remove all teams?')) return;
    state.teams=[]; nextTeamId=1; state.schedule=[]; state.standings=[]; state.rankings=[]; state.bracket=null;
    renderTeams(); el('#poolSchedule').innerHTML=''; el('#standings').innerHTML=''; el('#bracket').innerHTML=''; el('#champion').innerHTML='';
    el('#buildBracket').disabled=true; el('#finalizePool').disabled=true;
  });

  // Pool controls
  el('#makeSchedule').addEventListener('click', function(){ var rounds=parseInt(el('#roundCount').value,10); createSchedule(rounds); });
  el('#resetSchedule').addEventListener('click', function(){ state.schedule=[]; state.standings=[]; state.rankings=[]; el('#poolSchedule').innerHTML=''; el('#standings').innerHTML=''; el('#finalizePool').disabled=true; el('#buildBracket').disabled=true; });
  el('#finalizePool').addEventListener('click', finalizePool);

  // Bracket controls
  el('#buildBracket').addEventListener('click', buildBracketFromRankings);
  el('#resetBracket').addEventListener('click', function(){ state.bracket=null; el('#bracket').innerHTML=''; el('#champion').innerHTML=''; });

  // Tests
  el('#runTests').addEventListener('click', runTests);
  renderTeams();
});

/*****************************
 * Tests (basic, visible in console)
 *****************************/
function logResult(msg, ok){
  var line = document.createElement('div'); line.className = ok? 'pass' : 'fail';
  line.textContent = (ok? 'PASS: ' : 'FAIL: ') + msg; el('#testResults').appendChild(line);
  (ok? console.log : console.error)(line.textContent);
}
function resetAll(){ state.teams=[]; nextTeamId=1; state.schedule=[]; state.standings=[]; state.rankings=[]; state.bracket=null; renderTeams(); el('#poolSchedule').innerHTML=''; el('#standings').innerHTML=''; el('#bracket').innerHTML=''; el('#champion').innerHTML=''; el('#buildBracket').disabled=true; el('#finalizePool').disabled=true; el('#testResults').innerHTML=''; }
function runTests(){
  resetAll();
  // Enter/submit adds a team
  var form = el('#teamForm'); var input = el('#teamName');
  input.value = 'Echo';
  form.dispatchEvent(new Event('submit', { bubbles:true, cancelable:true }));
  logResult('Form submit adds team via Enter simulation', state.teams.length===1 && state.teams[0].name==='Echo');

  // Add team button adds team
  input.value = 'Foxtrot';
  el('#addTeam').click();
  logResult('Clicking Add team button adds team', state.teams.length===2 && state.teams[1].name==='Foxtrot');

  // Fresh
  resetAll();
  addTeam('Alpha'); addTeam('Bravo'); addTeam('Charlie'); addTeam('Delta');
  logResult('Added 4 teams', state.teams.length===4);

  // 5-round schedule has 4 matches + Bye row
  createSchedule(5);
  var fourGamesEach = state.schedule.every(function(r){ return r.matches.filter(function(m){return !m.isBye;}).length===4; });
  var byeRows = state.schedule.every(function(r){ return r.matches.length===5 && r.matches[r.matches.length-1].isBye===true && r.bye && r.bye.a===null && r.bye.b===null; });
  logResult('5-round schedule: exactly 4 matches per round', fourGamesEach);
  logResult('5-round schedule: Bye game present as last row with selectors', byeRows);

  // 4-round schedule has 4 matches and no Bye row
  resetAll(); ['A','B','C','D','E','F','G','H','I','J'].forEach(function(n){addTeam(n);});
  createSchedule(4);
  var fourGamesNoBye = state.schedule.every(function(r){ return r.matches.length===4 && r.matches.every(function(m){return !m.isBye;}); });
  logResult('4-round schedule: exactly 4 matches per round and no Bye row', fourGamesNoBye);

  // Bye validation: same team twice should fail
  var byeA = el('#byeA-1'); var byeB = el('#byeB-1');
  if(byeA && byeB){
    byeA.value = String(state.teams[0].id); byeB.value = String(state.teams[0].id);
    var blocked=false; var tempAlert=window.alert; window.alert=function(m){ if(String(m).includes('must be different')) blocked=true; };
    var idx0 = state.schedule[0].matches.findIndex(function(m){return !m.isBye;});
    el('#aScore-1-'+idx0).value='21'; el('#bScore-1-'+idx0).value='19';
    saveRound(1); window.alert=tempAlert;
    logResult('Bye selection blocks when the same team is chosen twice', blocked===true);
  } else {
    logResult('Skipped bye-same-team test (not in 5-round mode)', true);
  }

  // Now valid distinct bye teams and save R1
  if(el('#byeA-1') && el('#byeB-1')){
    el('#byeA-1').value = String(state.teams[0].id); el('#byeB-1').value = String(state.teams[1].id);
    var i1 = state.schedule[0].matches.findIndex(function(m){return !m.isBye;});
    el('#aScore-1-'+i1).value='21'; el('#bScore-1-'+i1).value='18';
    saveRound(1);
  }

  // Finalize must fail while unsaved matches remain
  var finalizeBlocked=false;
  var originalAlertX = window.alert;
  window.alert = function(msg){ if(String(msg).includes('unsaved match')) finalizeBlocked=true; };
  finalizePool(); window.alert = originalAlertX;
  logResult('Finalize blocked when unsaved matches remain', finalizeBlocked===true);

  // Bye uniqueness across rounds
  if(state.schedule.length===5){
    el('#byeA-2').value = String(state.teams[0].id);
    el('#byeB-2').value = String(state.teams[2].id);
    var blocked2=false; var prevAlert = window.alert; window.alert=function(m){ if(String(m).includes('only receive one bye')) blocked2=true; };
    var j0 = state.schedule[1].matches.findIndex(function(m){return !m.isBye;});
    el('#aScore-2-'+j0).value='21'; el('#bScore-2-'+j0).value='19';
    saveRound(2); window.alert=prevAlert;
    logResult('Bye uniqueness enforced across rounds', blocked2===true);
  } else {
    logResult('Skipped bye-uniqueness test (not in 5-round mode)', true);
  }

  // Rematch prevention (manual schedule)
  resetAll(); ['A','B','C','D','E','F','G','H','I','J'].forEach(function(n){addTeam(n);});
  el('#manualMode').checked = true; createSchedule(4);
  el('#aSel-1-0').value = String(state.teams[0].id);
  el('#bSel-1-0').value = String(state.teams[1].id);
  el('#aScore-1-0').value='21'; el('#bScore-1-0').value='18';
  function fill(r, idx, a,b){ el('#aSel-'+r+'-'+idx).value=String(a); el('#bSel-'+r+'-'+idx).value=String(b); el('#aScore-'+r+'-'+idx).value='21'; el('#bScore-'+r+'-'+idx).value='17'; }
  fill(1,1,state.teams[2].id,state.teams[3].id);
  fill(1,2,state.teams[4].id,state.teams[5].id);
  fill(1,3,state.teams[6].id,state.teams[7].id);
  saveRound(1);
  el('#aSel-2-0').value = String(state.teams[0].id);
  el('#bSel-2-0').value = String(state.teams[1].id);
  fill(2,1,state.teams[2].id,state.teams[3].id);
  fill(2,2,state.teams[4].id,state.teams[5].id);
  fill(2,3,state.teams[6].id,state.teams[7].id);
  var rematchBlocked=false; var prevAlert2 = window.alert; window.alert=function(m){ if(String(m).includes('Rematch detected')) rematchBlocked=true; };
  saveRound(2); window.alert=prevAlert2;
  logResult('Rematch prevention enforced across rounds', rematchBlocked===true);

  // Fast-forward to bracket and test best-of-3 final
  for(var rIdx=0; rIdx<state.schedule.length; rIdx++){
    var round = state.schedule[rIdx];
    for(var mIdx=0; mIdx<round.matches.length; mIdx++){
      var m = round.matches[mIdx];
      if(m.isBye) continue;
      if(m.a==null){ // ensure teams selected for manual
        el('#aSel-'+(rIdx+1)+'-'+mIdx).value = String(state.teams[(mIdx*2)%state.teams.length].id);
        el('#bSel-'+(rIdx+1)+'-'+mIdx).value = String(state.teams[(mIdx*2+1)%state.teams.length].id);
      }
      el('#aScore-'+(rIdx+1)+'-'+mIdx).value='21'; el('#bScore-'+(rIdx+1)+'-'+mIdx).value='19';
    }
    saveRound(rIdx+1);
  }
  finalizePool(); buildBracketFromRankings();
  function simpleAdvance(list, key){ list.forEach(function(mm, i){ if(mm.winner) return; recordBracketScore(key, i, 21, 19); }); }
  simpleAdvance(state.bracket.playins,'playins'); simpleAdvance(state.bracket.quarters,'quarters'); simpleAdvance(state.bracket.semis,'semis');
  renderBracket();
  var finalCol = el('#bracket');
  var inputs = finalCol.querySelectorAll('.bracket-col:last-child input');
  inputs[0].value='25'; inputs[1].value='22'; // Set 1
  inputs[2].value='25'; inputs[3].value='23'; // Set 2
  finalCol.querySelector('.bracket-col:last-child button').click();
  var champSet = !!el('#champion').textContent.includes('Champion');
  logResult('Final best-of-3 determines champion with 2-0', champSet===true);
}
</script>
</body>
</html>
